# POP3メール転送ソフトウェア 仕様書

## 1. 概要
プロバイダのメールアカウント（POP3）からメールを取得し、同プロバイダのSMTPサーバー経由で指定した任意のメールアドレスに転送するPythonアプリケーション。

**主な用途**:
- GmailのPOP3吸出し機能廃止に伴う代替ソリューション
- 複数のメールアカウントを1つのメールボックスに集約
- プロバイダメールを別のメールサービス（Gmail、Outlook、iCloud等）に統合

**転送方式**: 通常のメールソフト（Becky!等）と同等の動作を行うため、プロバイダの利用規約に準拠した動作を保証。

## 2. 機能要件

### 2.1 メール取得機能
- POP3プロトコルを使用してプロバイダのメールサーバーからメールを取得
- SSL/TLS接続に対応
- 定期的な自動チェック（設定可能な間隔）

### 2.2 重複防止機能
- 取得済みメールの管理にUIDL（Unique ID Listing）を使用
- ローカルにUIDLリストを永続化（SQLiteまたはテキストファイル）
- 新規メールのみを取得対象とする

### 2.3 転送機能
- プロバイダのSMTPサーバー経由でメールを転送
- SMTP認証（SMTP AUTH）を使用
- 元のメールヘッダー情報を保持
- From、Subject、Date等の情報を維持
- 通常のメールソフトと同等の動作

### 2.4 エラーハンドリング
- ネットワークエラー時の再試行ロジック
- ログ出力機能（日次ローテーション、30日保持）
- エラー通知（将来実装予定: メール/Slack等）

### 2.5 メール削除機能
- **保持期間管理**: 転送済みメールの保持期間を設定可能
- **デフォルト設定**: 30日経過したメールを削除
- **設定可能範囲**: 
  - `mail_retention_days: 0` - 削除しない（無期限保持）
  - `mail_retention_days: 1~365` - 指定日数経過後に削除
- **削除タイミング**: メールチェック時に、転送成功かつ保持期間を超えたメールを削除
- **安全機構**: 転送失敗したメールは削除対象から除外

## 3. 技術仕様

### 3.1 起動オプション
プログラムは以下の2つの動作モードをサポート：

#### 3.1.1 ワンショットモード（デフォルト）
- 1回だけメールチェック・転送を実行して終了
- cron/タスクスケジューラでの定期実行に適している
- コマンド例: `python mail_forwarder.py --once`

#### 3.1.2 デーモンモード
- プログラム内で指定間隔で連続してメールチェックを実行
- 間隔は起動オプションまたは設定ファイルで指定
- コマンド例: `python mail_forwarder.py --daemon --interval 300`（5分間隔）
- Ctrl+Cまたはシグナルで終了

**オプション一覧:**
- `--once`: ワンショットモードで実行（デフォルト）
- `--daemon`: デーモンモードで実行
- `--interval <秒数>`: チェック間隔（デーモンモード時のみ有効、デフォルト: 300秒）
- `--config <ファイルパス>`: 設定ファイルのパス指定
- `--setup`: 対話型セットアップウィザードを起動（初回利用者向け）
- `--test-config`: 設定ファイルの接続テストを実行
- `--start-date <日時>`: この日時以降のメールのみ転送（初回テスト用）
  - 形式: `YYYY-MM-DD` または `YYYY-MM-DD HH:MM:SS`
  - 例: `2025-12-30` または `2025-12-30 15:30:00`

### 3.2 使用プロトコル
- **受信**: POP3 over SSL/TLS (ポート995)
- **送信**: SMTP over SSL/TLS (ポート587推奨、または465)
  - サブミッションポート（587）使用を推奨（OP25B対策）
  - SMTP認証必須
- **POP before SMTP対応**:
  - 一部の古いプロバイダで必要な認証方式に対応
  - SMTP送信前にPOP3認証を実行することでSMTP送信を許可
  - 設定ファイルで有効/無効を切り替え可能

### 3.3 データ保存
- **UIDL管理**: SQLiteデータベース（`data/mail_uidl.db`）
  - テーブル構成: `retrieved_mails(uidl TEXT PRIMARY KEY, forwarded_at DATETIME, from_addr TEXT, subject TEXT, forward_success BOOLEAN)`
  - `forwarded_at`: 転送成功日時（削除判定に使用）
  - `forward_success`: 転送成功フラグ（削除対象判定に使用）
  - 将来的な拡張（統計、検索）を考慮した設計

### 3.4 設定ファイル
- **設定形式**: YAML（`config.yaml`）
- **サンプルファイル**: `config.yaml.example`を提供
- **設定項目**:
  - POP3サーバー情報（ホスト、ポート、ユーザー名、パスワード）
  - SMTPサーバー情報（ホスト、ポート、ユーザー名、パスワード）
  - **POP before SMTP**（`pop_before_smtp`）: true=有効、false=無効（デフォルト）
  - 転送先メールアドレス（Gmail、Outlook、iCloud等、任意のアドレス）
  - デーモンモード時のデフォルトチェック間隔
  - ログレベル（DEBUG, INFO, WARNING, ERROR）
  - ログ出力設定
  - **メール保持期間**（`mail_retention_days`）: 0=削除しない、1~365=指定日数後削除、デフォルト30日

## 4. セキュリティ要件
- パスワードは環境変数または暗号化された設定ファイルで管理
- SMTP認証（SMTP AUTH）を使用
- 通信は全てSSL/TLS暗号化
- プロバイダの利用規約に準拠した動作（通常のメールソフトと同等）

## 5. 実装言語ライブラリ
- **言語**: Python 3.9以上
- **推奨ライブラリ**:
  - `poplib`: POP3クライアント（標準ライブラリ）
  - `smtplib`: SMTPクライアント（標準ライブラリ）
  - `email`: メール解析・作成（標準ライブラリ）
  - `sqlite3`: データベース（標準ライブラリ）
  - `pyyaml`: 設定ファイル読み込み
  - `logging`: ロギング（標準ライブラリ）

## 5.5 プロジェクト構成
```
├── mail_forwarder.py      # メインプログラム
├── config.yaml            # 設定ファイル（.gitignore対象）
├── config.yaml.example    # 設定サンプル
├── requirements.txt       # 依存ライブラリ
├── README.md             # 使い方説明
├── .gitignore            # Git除外設定
├── logs/                 # ログディレクトリ
│   └── mail_forwarder.log
└── data/                 # UIDL DBディレクトリ
    └── mail_uidl.db
```

## 5.6 ログ仕様
- **出力先**: `logs/mail_forwarder.log`
- **ローテーション**: 日次（午前0時）
- **保持期間**: 30日
- **ログレベル**: DEBUG, INFO, WARNING, ERROR
- **フォーマット**: `[%(asctime)s] %(levelname)s - %(message)s`
- **出力内容**:
  - 転送成功したメールのみ詳細表示（From、Subject、日時）
  - スキップしたメールは件数のみサマリー表示
  - エラーは全て詳細表示

## 6. 動作フロー

### 6.1 ワンショットモード
1. 設定ファイルを読み込み
2. POP3サーバーに接続
3. サーバーから全メールのUIDLリストを取得
4. ローカルDB/ファイルから取得済みUIDLリストを読み込み
5. 差分（新規メール）を特定
6. 新規メールを取得
7. プロバイダSMTPサーバー経由で転送先アドレスに転送
8. 取得済みUIDLをローカルに保存
9. 接続を切断
10. プログラム終了

### 6.2 デーモンモード
1. 設定ファイルを読み込み
2. 以下を無限ループ:
   - POP3サーバーに接続
   - サーバーから全メールのUIDLリストを取得
   - ローカルDB/ファイルから取得済みUIDLリストを読み込み
   - 差分（新規メール）を特定
   - 新規メールを取得
   - プロバイダSMTPサーバー経由で転送先アドレスに転送
   - 取得済みUIDLをローカルに保存
   - 接続を切断
   - 指定間隔スリープ
3. 終了シグナル受信時にループを抜けて終了

## 7. ユーザビリティ向上機能

### 7.1 対話型セットアップウィザード（--setup）
- 初回利用者向けの設定ファイル作成ツール
- 各設定項目を対話形式で入力
- パスワードはマスク表示
- 設定完了後、自動的に接続テストを実施

### 7.2 設定テスト機能（--test-config）
- POP3サーバーへの接続テスト
- SMTPサーバーへの接続テスト
- 認証の確認
- 結果を分かりやすく表示

### 7.3 エラーメッセージの改善
- 日本語での分かりやすいエラーメッセージ
- 解決方法のヒントを表示
- よくあるエラーの対処法を明記

### 7.4 プロバイダ別設定例
- README.mdに主要プロバイダの設定例を記載
- OCN、ぷらら、So-net、BIGLOBE等
- ポート番号やホスト名の一覧

## 8. 今後の拡張案
- 複数アカウント対応
- フィルタリング機能（特定の送信者のみ転送等）
- Webダッシュボード
- Docker対応
- GUI版の開発

---
作成日: 2025年12月30日
最終更新: 2025年12月30日
